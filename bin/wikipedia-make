#!/usr/bin/python3

import sys
import unicodedata
import wptools
import uuid
import yaml

sys.path.append('')
from rengu.tools import YamlDumper, walk_search
from rengu.check import find_author

from blitzdb import FileBackend
from blitzdb.document import DoesNotExist

from rengu.db.authors import Author

def normalize(input_str):
    # Returns a NFKD normalized form of the input string
    nfkd_form = unicodedata.normalize('NFKD', input_str)
    return u"".join([c for c in nfkd_form if not unicodedata.combining(c)])


def wiki_page(name):

    page = wptools.page(normalize(name), silent=True, skip=['imageinfo'])
    try:
        page.get(timeout=5)
    except LookupError:
        page.data = {'what': "_error lookup_"}
        return page
    except RecursionError:
        page.data = {'what': "_error recusion_"}
        return page
    except:
        page.data = {'what': "_error other_"}
        return page

    if not 'label' in page.data:
        page.data = {'label': "_error no label_"}

    return page

if __name__ == '__main__':

    backend = FileBackend("./db")

    for name in [x.strip() for x in sys.stdin.readlines()]:
        page = wiki_page(name)

        label = page.data.get("label")
        url = page.data.get("url", "")
        what = page.data.get("what", "NONE")

        #wikibase = page.data.get("wikibase")
        #pegeid= page.data.get("pageid")

        if type(what) is tuple:
            what = ','.join(what)
        if what == 'Wikimedia disambiguation page':
            what = "_disambiguate_"

        if what == 'human':

            exists = find_author(backend, name)
            if exists:
                print("Weird ... I already have" ,name, exists.Name)
                continue

            data = find_author(backend, label)
            if data:
                data = dict(data)

                uid = str(uuid.UUID(data['_id']))
                del data['_id']

                if data.get('AlternateNames'):
                    data['AlternateNames'].append(name)
                else:
                    data['AlternateNames'] = [ name ]

            else:
                uid = str(uuid.uuid4())

                data = {
                    "Name" : label,
                    "URLs" : [ url ]
                }

                if name != label:
                    data['AlternateNames'] = [ name ]

            # from pprint import pprint
            # pprint(data)

            f = open('output/' + uid, 'w')

            f.write("---\n")
            f.write(
                yaml.dump(
                    data,
                    Dumper=YamlDumper,
                    default_flow_style=False,
                    width=70,
                    indent=2).strip())
            f.write("\n---\n")
            f.close()

